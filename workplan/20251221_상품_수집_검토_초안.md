# 상품 수집 검토 초안 (신규 프로젝트 기준)

## 1. 목적
- 공급사가 보유한 모든 상품을 빠짐없이 수집한다.
- 판단/선별 없이 100% RAW로 수집한다.
- 실패/불완전 데이터도 그대로 저장한다.

## 2. 범위
- 대상: 공급사 상품 수집(1차 소싱)
- 포함: 입력/수집, 원본 저장, 상태 기록, 재시도
- 제외: 가공/정규화, 판단/선별, 마켓 등록, 주문 연동, 정산/CS

## 3. 수집 단계 산출물 정의
- 원본 스냅샷: 공급사 제공 전체 데이터(JSONB) + 관련 원본(이미지 URL, 상세 페이지 HTML 등)
- 수집 상태: 성공/실패만 기록

## 4. 상태 모델(초안)
- `SOURCING_PENDING`: 수집 대기
- `SOURCING_RUNNING`: 수집 중
- `SOURCING_SUCCESS`: 수집 성공(원본 저장 완료)
- `SOURCING_FAILED`: 수집 실패(원인 기록)

## 5. 저장 원칙
- 공급사가 제공한 전체 데이터를 JSONB 형태로 로컬 DB에 원본 그대로 저장한다.
- 이미지 URL, 상세 페이지 HTML 등 모든 정보를 수정 없이 저장한다.

## 6. 수집 규칙(초안)
- 절대 가공하지 않음
- 절대 삭제하지 않음
- 실패/불완전 데이터도 그대로 저장

## 7. 재시도 규칙(초안)
- 네트워크/일시 오류: 최대 N회 재시도
- 인증 오류: 즉시 실패 + 알림
 
권장 기본값:
- 네트워크/일시 오류: 3회 재시도(5s → 30s 지수 백오프 + 지터)
- HTTP 401/403: 즉시 실패(재시도 없음)
- HTTP 429: 3회 재시도(`Retry-After` 존중)
- 기타 4xx: 즉시 실패
- 5xx: 3회 재시도
## 8. 수집 범위
- 공급사 상품 전체
- 날짜 기준 증분 수집
  - 신규 상품
  - 수정 상품
  - 가격/재고/옵션 변경

## 9. 체크 포인트
- 날짜 기준 스냅샷 설계
- 동일 SKU의 변경 이력 추적
- 수집 성공/실패만 기록(품질 판단 없음)

## 10. 관측성(초안)
- 수집 로그: 공급사/외부상품ID/상태/오류코드
- 실패 스냅샷: 원본 + 파싱 로그 + 규칙 위반 내용
- 대량 수집 시 배치 단위 요약 기록

## 11. 미확정 질문
- 수집 실패 시 재시도 정책(N회, 간격) 정의 필요
- 중복 수집 기준(상품 ID vs 해시) 확정 필요

## 12. 결정 사항
- 1차 수집 소스: 오너클랜
- 기존 오너클랜 수집 코드 최소 수정 원칙
- 로컬 신규 DB 사용(비밀번호 없이 구성)
- RAW 저장 스키마: 완전 이력형(append-only)
- 증분 수집 기준: 기존 로직 유지(날짜 범위 + 커서)
- 중복 판단 기준: item_code

## 13. 기존 오너클랜 수집 흐름 요약(참고)
- 트리거: `SupplierSyncJob` 생성 후 백그라운드 실행
- 엔드포인트: `/sync/ownerclan/items` → `ownerclan_items_raw` 잡 생성
- 실행: `run_ownerclan_job` → `sync_ownerclan_items_raw`
- 조회: GraphQL `allItems(dateFrom, dateTo, after, first)` 호출
- 증분 기준: 날짜 범위 + 커서(`SupplierSyncState`에 `watermark_ms`/`cursor` 저장)
- 요청/응답 로깅: `SupplierRawFetchLog`
- 저장: `SupplierItemRaw`에 JSONB로 raw 저장(현재는 upsert)

## 14. 현재 사용 테이블 요약(참고)
- `supplier_accounts`: 공급사 계정/토큰
- `supplier_sync_jobs`: 수집 작업 큐/상태
- `supplier_sync_state`: 증분 수집 워터마크/커서
- `supplier_raw_fetch_log`: 원본 요청/응답 로그
- `supplier_item_raw`: 상품 raw(JSONB) 저장

## 15. 현재 코드와 신규 원칙의 차이
- 현재는 `SupplierItemRaw`가 upsert로 동작 → 변경 이력 누적 불가
- 현재는 `detail_html` 정규화 수행 → 신규 원칙(무가공)과 충돌
- 현재는 실패 데이터 저장이 제한적 → 신규 원칙은 실패/불완전 데이터도 보존

## 16. RAW 저장 스키마 초안(완전 이력형)
- 테이블명(가칭): `supplier_item_raw_history`
- 목적: item_code 기준으로 모든 변경 이력을 누적 저장
- 핵심 원칙: 절대 삭제/수정 없이 append-only

필드 초안(로컬 PostgreSQL, JSONB):
- `id`: UUID (PK)
- `supplier_code`: TEXT (예: `ownerclan`)
- `item_code`: TEXT (중복 판단 기준)
- `item_key`: TEXT (선택)
- `item_id`: TEXT (선택)
- `source_updated_at`: TIMESTAMPTZ (공급사 updatedAt 기준)
- `fetched_at`: TIMESTAMPTZ (수집 시각)
- `raw`: JSONB (공급사 제공 전체 데이터)
- `fetch_status`: TEXT (`success` 또는 `failed`)
- `error_message`: TEXT (실패 시 원문)
- `batch_id`: UUID (같은 수집 배치 식별자)

인덱스 초안:
- `(supplier_code, item_code, source_updated_at)`
- `(supplier_code, fetched_at)`
- `(supplier_code, batch_id)`

확정 사항:
- 완전 이력형(append-only)로 운영
- 중복 판단 기준은 `item_code`
- 원본은 가공 없이 `raw`에 저장

DDL 예시(초안):
```
CREATE TABLE supplier_item_raw_history (
  id UUID PRIMARY KEY,
  supplier_code TEXT NOT NULL,
  item_code TEXT NOT NULL,
  item_key TEXT,
  item_id TEXT,
  source_updated_at TIMESTAMPTZ,
  fetched_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  raw JSONB NOT NULL,
  fetch_status TEXT NOT NULL DEFAULT 'success',
  error_message TEXT,
  batch_id UUID
);
CREATE INDEX ix_raw_history_item_code ON supplier_item_raw_history (supplier_code, item_code, source_updated_at);
CREATE INDEX ix_raw_history_fetched_at ON supplier_item_raw_history (supplier_code, fetched_at);
CREATE INDEX ix_raw_history_batch_id ON supplier_item_raw_history (supplier_code, batch_id);
```

정책 요약:
- upsert 금지, 무조건 append
- 실패/불완전 데이터도 동일 테이블에 저장(`fetch_status=failed`)

## 17. 신규 레포 구조(초안)
- 목표: 신규 프로젝트 전용 구조로 독립 운영
- 최소 구성 기준: 수집 파이프라인 중심 + 확장 가능

디렉토리 초안:
- `app/`: FastAPI 백엔드(수집 API/잡)
- `app/api/`: 수집 트리거/상태 조회 엔드포인트
- `app/services/`: 오너클랜 수집 로직
- `app/models/`: DB 모델 및 스키마
- `alembic/`: 마이그레이션
- `scripts/`: 수집 테스트/배치 실행 스크립트
- `docs/`: 설계/운영 문서
- `workplan/`: 계획 문서
- `frontend/`: (필요 시) 운영 UI

필수 문서 초안:
- `README.md`: 설치/실행/환경변수
- `docs/collection.md`: 수집 규칙/상태/재시도 정책

## 18. 증분 수집 파라미터 기본값(초안)
- `dateFrom`: 기존 `SupplierSyncState.watermark_ms - overlap` 기준 유지
- `dateTo`: 현재 시각(ms)
- `overlap`: 30분
- `first`: 100
- `maxItems`: 0 (제한 없음)
- `maxPages`: 0 (제한 없음)
- `after`: 기존 커서(`SupplierSyncState.cursor`) 우선 사용

## 다음 단계 제안
1) 오너클랜 수집 흐름/테이블/잡 구조 요약
2) RAW 저장 스키마(JSONB) 초안 작성
3) 날짜 기준 증분 수집 기준 확정
4) 중복 판단 기준 및 재시도 정책 확정
